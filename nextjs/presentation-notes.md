---
tags: [presentation, nextjs]
---

# Intro to Next.js

# Problem 
- JavaScript heavily used on web 
- Large bundle downloads
- Often JavaScript code may just generates static content 
  - Could return static JS and reduce bundle size
- If data is retrieved via API, how often does it change?
  - If not often, it can be statically generated

<br/><br/><br/><br/><br/>

# Solution 
- Static and/or server side rendering 
  - Movement by industry to move more to the server
  - See: [Next.js](https://nextjs.org/), [React Server Components](https://reactjs.org/blog/2020/12/21/data-fetching-with-react-server-components.html), [Gatsby](https://www.gatsbyjs.com/), and others.

## Static
- [Reference](https://nextjs.org/docs/basic-features/pages#static-generation-with-data)
- Very fast, most ideal scenario
- Pre-render all JS at build time into static HTML / JS
- Can be done even when data is fetched from an API 
- Ideal for scenarios where data does not change often

## Server-side Rendering
- [Reference](https://nextjs.org/docs/basic-features/data-fetching#getserversideprops-server-side-rendering)
- Fast, lower bundle size than all client based
- HTML generated by server at request time on the server 
- When data is dynamic and changes frequently

<br/><br/><br/><br/><br/>

# Example Application 
- [Simple User List](https://github.com/dstanich/simple-user-list/tree/master/nextjs)
- Basic app that queries an API for random users
  - Shows list of all users 
  - Clicking user shows full user JSON
- Contains examples of most things in this document

<br/><br/><br/><br/><br/>

# Next.js Setup and Structure
## Installation
```bash
# Install helper CLI
npm install -g create-next-app

# Create a new project (use-npm optional)
create-next-app <proj-name> --use-npm

# Run development version of Next.js app 
npm run dev
```

## Directory Structure 
The structure below is annotated with which folders are required versus only being a suggested path.

- `.next/`
  - Build output.  Optimized build output (only after `npm run build` has been run).
- `components/`
  - Suggested. Reusable components for use on pages 
- `out/`
  - Build output. Static build output (only after `next export` has been run)
- `pages/`
  - Required. Page level components that feed into router 
- `public/`
  - Required. Static assets like images
- `styles/`
  - Suggested. CSS files for loading into components

<br/><br/><br/><br/><br/>

# CSS 
## SASS 
- Built-in support 
- Enable by installing `sass` NPM module: `npm install sass`
- Ensure file extensions are correct (`.scss` or `.sass`)

## Global Styles 
- Importing regular CSS into app may only be done in `_app.js`
- Imports will apply to entire application, cannot be scoped 

## Scoped Styles (CSS Modules)
- Styles scoped to only the page/component that imports it via [CSS modules](https://github.com/css-modules/css-modules)
- Create CSS files with `.module` in the name 
  - Ex: `styles/User.module.scss`
- Import into page or component 
  - `import ../styles/User.module.scss`

<br/><br/><br/><br/><br/>

# Images 
- Next.js has built in image optimization ([Reference](https://nextjs.org/docs/basic-features/image-optimization#image-component))
- Lazy loads images
  - Only loads when scrolled into view
- Images served differently depending on viewport size 

**`next.config.js` Changes**
```JavaScript
// If source is another domain, add domain to config file 
module.exports = {
  images: {
    domains: ['somehost.com'],
  },
};
```

**Component File Changes**
```JavaScript
import Image from 'next/image'

<Image
  src="/some-picture.png"
  alt="Alt text"
  width="32"
  height="32
/>
```

<br/><br/><br/><br/><br/>

# Routing 
## Basics 
- Router reads `pages/` directory 
  - `pages/index.js` ==> `http://url/`
  - `pages/user/index.js` ==> `http://url/user`
- Dynamic paths 
  - `pages/user/[id].js` ==> `http://url/user/1234`
- Catch all router 
  - Catches all dynamic routes not explicitly defined
  - `pages/user/[...id].js`

## Linking 
- Import `next/link` for linking between pages 

```JavaScript
<Link href="/user/1234">
  <a href="">Home</a>
</link>
```

## `useRouter()` Hook 
- Import from `next/router`
- `const router = useRouter()`
- Can retrieve things like the parameters and query string

<br/><br/><br/><br/><br/>

# Page Generation Strategies 
## Static Generation
- [Reference](https://nextjs.org/docs/basic-features/data-fetching#getstaticprops-static-generation)
- One of the most powerful Next.js features 
- Enables pieces of application that don't change to be simple HTML 
- `getStaticProps()`
  ```
  export function async getStaticProps(context) {
    // Fetch 
    return {
        props: {
        /* props to send */ 
        }
    };
  }
  ```
  - Props will get injected into component at **build time**
  - Executed only on server, can use NodeJS features
  - Only allowed in pages, not components 
- `getStaticPaths()`
    ```
    export async function getStaticPaths() {
      // Fetch 
      return {
        paths: [
          { params: [/* */] },
          fallback: true | false
        ]
      }
    }
    ```
    - Statically generates paths based on returned data 
    - Executed only on server, can use NodeJS features
    - `fallback`
      - `true` - if path not found, Next.js will generate it statically on demand 
      - `false` - if path not found, show 404

## Server Side Rendering (SSR)
- [Reference](https://nextjs.org/docs/basic-features/data-fetching#getserversideprops-server-side-rendering)
- Export `getServerSideProps()` 
  - Tells app to pre-render page on request 
  - Injects returned props into component 
- Only allowed in a page and not component 
- Useful when...
  - Fetch data on server side 
  - Render pages or components on server

## Client Side Data Fetching
- Fetch data in pages/components as you normally would 
- Next.js has a hook called `useSWR()` ([Ref](https://nextjs.org/docs/basic-features/data-fetching#swr))
  - Optional 
  - Can help with caching, simple calls

<br/><br/><br/><br/><br/>

# API Routes 
- [Reference](https://nextjs.org/docs/api-routes/introduction)
- Next.js provides mechanism to serve API from same project 
  - Simplifies deployment / context switching for developer
- Configured to accept same origin requests only 
- Server side only, does not get bundled with client

## Implementing
- Add `pages/api/<filename>.js` where filename is route 
  - Ex: `api/users.js` maps to `http://url/api/users`
- Dynamic routes with brackets
  - `pages/user/[id].js` ==> `http://url/api/user/<user-id>`
- Code is executed server side, may import NodeJS features
- Each API must export a handler function

```JavaScript
export default function handler(req, res) {
  // Filter out HTTP methods you don't want
  if (req.method !== 'GET') {
    res.status(405);
  }

  // Fetch data or update backend
  // Call REST, query DB, whatever you need
  
  // Return the JSON data
  res.status(200).json(JSON_DATA_HERE));
}
```

<br/><br/><br/><br/><br/>

# Building 
## Optimized Next.js Server Output
- [Reference](https://nextjs.org/docs/deployment#other-hosting-options)
```bash
# Create optimized build (from root of project)
npm run build

# Start the application using optimized build 
npm start
```

- Optimized build requires Next.js server in deployment 
- Server required for serving static files, SSR, etc.
- Build creates as much static output as possible 
- Terminal output indicates how things are being generated 

```
Page                                                   Size     First Load JS
┌ ● /                                                  2.9 kB         68.2 kB
├   └ css/8705a14c26a90f88b1f2.css                     652 B
├   /_app                                              0 B            65.3 kB
├ ● /[seed]/user/[id]                                  1.96 kB        67.3 kB
├   └ css/116bfc9b10dfeebecbf9.css                     141 B
├   ├ /demo/user/e716a2a1-d598-4953-8318-c9b793ebc7e0
├   ├ /demo/user/bf69e4f9-a050-438a-900b-38b6b94764a8
├   ├ /demo/user/6003add0-c3b0-4b6e-9c87-10a19539db02
├   └ [+47 more paths]
├ ○ /404                                               3.03 kB        68.3 kB
└ λ /api/hello                                         0 B            65.3 kB
+ First Load JS shared by all                          65.3 kB
  ├ chunks/commons.1c81e1.js                           13.1 kB
  ├ chunks/framework.9d5241.js                         41.8 kB
  ├ chunks/main.0ec8ef.js                              6.63 kB
  ├ chunks/pages/_app.e09886.js                        3.09 kB
  ├ chunks/webpack.50bee0.js                           751 B
  └ css/7f49d7c8705f73eadad9.css                       344 B

λ  (Server)  server-side renders at runtime (uses getInitialProps or getServerSideProps)
○  (Static)  automatically rendered as static HTML (uses no initial props)
●  (SSG)     automatically generated as static HTML + JSON (uses getStaticProps)
   (ISR)     incremental static regeneration (uses revalidate in getStaticProps)
```

## Static Export of Application 
- [Reference](https://nextjs.org/docs/advanced-features/static-html-export)
- Some applications may export statically
- Does not require Next.js server component 
- Typically only if data is static or JS code fetches all data 
- Cannot use if fallback enabled or incremental static regeneration 
- Requires user to provide own HTTP server
  
```bash
# Build optimized Next.js output (.nextjs/)
npm run build 

# Export to static output (out/)
npx next export
```

<br/><br/><br/><br/><br/>

# Final Notes and Thoughts
## Notes 
- `npm run dev` calls `getStaticProps()` and `getStaticPaths()` on demand
  - May make things seem slower than they really are
  - Do a build then `npm start` to see full effect
- TypeScript support is built-in - [Reference](https://nextjs.org/docs/basic-features/typescript)

## Thoughts
- Powerful framework
- Opinionated structure 
  - Easier for team to agree or search for answers
- Useful features even if majority of pages cannot be static 
  - Provides additional features without any extra work...
    - HTTP server
    - Easy routing
    - CSS modules 
    - Image optimization 
    - Server side generation 
- Consider if using React, likely to speed up development
